/* * product list  --douzy */define(function(require,exports,module){	var $=require("$");	require("ace-elements");	require("validation")($);	var tree=require("tree");	var courseTree=new tree();	var  Map=require("map");	var shopDistrictMap=new Map();	var newTeacherForm=$("#newTeacherForm");	var newTeacherButton=$("#newTeacherButton");	var phoneInput=$("#phoneInput");	var queryKey=$("#queryKey");	var queryUpKey=$("#queryUpKey");		var nowDistricts=null;	var allSelectButton=$("#allSelectButton");	$(".chosen-select").chosen(); 	$('#form-field-select-4').addClass('tag-input-style');			$('#shoppingDistrictsSelect').addClass('tag-input-style');	//$('#courseTypeSelectId').addClass('tag-input-style');				$('.search-field input').height(25);	$('.date-picker').datepicker({autoclose:true}).next().on(ace.click_event, function(){		$(this).prev().focus();	});		var J=$;	$("#avatarUpload").dropzone({        url: _contentPath+'/common/resource/image/upload.json',        maxFiles: 10,        maxFilesize: 3,        previewsContainer:false,        init: function() {            this.on("success", function(file,data) {            	var image=eval('(' + data + ')');                console.log("File " + image.image.url + "uploaded");                J("#avatarInput").val(image.image.url);                J("#avatarUpload").attr("src",image.image.url);            });            this.on("removedfile", function(file) {                console.log("File " + file.name + "removed");            });        }    });		var func = {						init : function(data) {				var self = this;				courseTree.init();				newTeacherForm.validation(function(obj,params){					console.log(obj);					if(obj.id=="queryKey"){												J.post(_contentPath+'/user/agent/check/phone/'+queryKey.val()+'.json',null,function(data){							 params.err = (data.result == 1 || data.result == 2) ? false : true;							 if(params.err){								 if(data.result==0){									 params.err = false;									 params.msg =  "代理商已经存在,可做修改操作";									 $("#idInput").val(data.userAgent.id);									 $("#phoneInput").val(queryKey.val());									 $("#userNameInput").val(data.user.nickName);									 $("#userIdInput").val(data.user.id);									 $("#parentIdInput").val(data.userAgent.parentId)									 $("#agentLevelOldInput").val(data.userAgent.agentLevelOld);									 $("#agentPiontOldInput").val(data.userAgent.agentPiontOld);									 var level = data.userAgent.agentLevel;									 $("#form-field-select-1").val(level);									 if(level == 2){										 $("#area").show();										 $("#Province").val(data.userAgent.provinceCode);										 CityBind();										 $("#City").val(data.userAgent.cityCode);										 VillageBind();										 $("#Village").val(data.userAgent.countyCode);									 }else{										 agentChange();									 }									 var parentUserAgent = data.parentUserAgent;									 if(parentUserAgent == null){										 $("#upPhoneInput").val(null);										 $("#upUserNameInput").val(null);										 $("#upAagentLevelInput").val(null);									 }else{										 $("#upPhoneInput").val(parentUserAgent.phone);										 $("#upUserNameInput").val(parentUserAgent.userName);										 var parentAgentLevel = parentUserAgent.agentLevel;										 var agentLevelName="区县代理";										 if(parentAgentLevel==3){											 agentLevelName="中心代理";										 }										 if(parentAgentLevel==4){											 agentLevelName="星级代理";										 }										 $("#upAagentLevelInput").val(agentLevelName);									 }								 }								 if(data.result==-1){									 params.msg =  "用户不存在请先注册";									 phoneInput.val(null);									 J("#userNameInput").val(null);									 J("#userIdInput").val(null);									 clean();								 }							 }else{								 var phone = queryKey.val();								 var myPhone = data.myphone;								 if(phone == myPhone){									 params.err = true;									 params.msg =  "不能维护自己为代理商";									 phoneInput.val(null);									 J("#userNameInput").val(null);									 J("#userIdInput").val(null);									 clean();								 }else{									 phoneInput.val(phone);									 J("#userNameInput").val(data.user.nickName);									 J("#userIdInput").val(data.user.id);									 clean();								 }							 }					        },'json');										}										if(obj.id=="queryUpKey"){												if(queryUpKey.val().length>0){						J.post(_contentPath+'/user/agent/'+queryUpKey.val()+'.json',null,function(data){							 params.err = data.result ==1 ? false : true;							 params.msg="";							 if(params.err){								 if(data.result==0)								 params.msg =  "代理商不存在";								 J("#upUserNameInput").val("");								 J("#upUserIdInput").val("");								 J("#parentIdInput").val("0");								 J("#upAgentLevelInput").val("");								 J("#upPhoneInput").val('');							 }else{								 if(data.agentVo.userId==J("#userIdInput").val()){									 params.err=true;									 params.msg =  "上下级代理不能是同一人";								 }else if(data.agentVo.agentLevel>=J("#form-field-select-1").val()){									 params.err=true;									 params.msg =  "上级代理要比当前代理等级高";								 }else{									 J("#upUserNameInput").val(data.agentVo.userName);									 J("#upUserIdInput").val(data.agentVo.userId);									 J("#parentIdInput").val(data.agentVo.userId);									 J("#upPhoneInput").val(queryUpKey.val());									 J("#upAgentLevelInput").val(data.agentVo.agentLevel);									 var agentLevelName="";									 if(data.agentVo.agentLevel==1){										 agentLevelName="代理商管理员";									 }									 if(data.agentVo.agentLevel==2){										 agentLevelName="区县代理";									 }									 if(data.agentVo.agentLevel==3){										 agentLevelName="中心代理";									 }									 if(data.agentVo.agentLevel==4){										 agentLevelName="星级代理";									 }									 J("#upAagentLevelInput").val(agentLevelName);								 }								 							 }					        },'json');						}else{														 J("#upUserNameInput").val('');							 J("#upUserIdInput").val('');							 J("#parentIdInput").val(0);							 J("#upPhoneInput").val('');							 J("#queryUpKey").val('');							 J("#upAgentLevelInput").val('');						}										}					//if(obj.id=="province")					//{					//	var len=$("#"+obj).val();					//	console.log(len);					//	params.err=false;					//}					//return false;				 },{reqmark:false} );				newTeacherButton.bind('click', function(event) {					self.teacherButtonClick(event);				});				allSelectButton.bind('click', function() {					allSelectEvent();				});				queryUpKey.bind('change',function(evnet){									});			},			teacherButtonClick:function(event){								  if (newTeacherForm.valid(this,"error!")==false){				       //$("#error-text").text("error!"); 1.0.4版本已将提示直接内置掉，简化前端。										  return false;				     }				  if ( J("#upAgentLevelInput").val()>=J("#form-field-select-1").val()){				       //$("#error-text").text("error!"); 1.0.4版本已将提示直接内置掉，简化前端。					  alert("上级代理要比当前代理等级高");					  return false;				     }				  var phone = $("#queryKey").val();				  if (typeof(phone) == "undefined" || phone == "") {						alert("请输入手机号码");						return;					}				  J("#agentLevelInput").val(J("#form-field-select-1").val());				  var agentLevel = $("#agentLevelInput").val();				  var agentOldLevel = $("#agentLevelOldInput").val();				  if(agentOldLevel != '' && agentOldLevel != 0 && agentOldLevel < agentLevel){					  alert("不允许降低代理商等级");					  return;				  }				  if(agentLevel == 2){					var province = $("#Province").val();					if (typeof(province) == "undefined" || province == "" || province == "==请选择===") {						alert("请选择省份");						return;					}					$("#provinceCodeInput").val(province);					var city = $("#City").val();					if (typeof(city) == "undefined" || city == "" || city == "==请选择===") {						alert("请选择市(直辖市)");						return;					}					$("#cityCodeInput").val(city);					var county = $("#Village").val();					if (typeof(county) == "undefined" || county == "" || county == "==请选择===") {						alert("请选择区县");						return;					}					$("#countyCodeInput").val(county);				}else{					$("#provinceCodeInput").val(null);					$("#cityCodeInput").val(null);					$("#countyCodeInput").val(null);				}				  			    newTeacherForm.submit();			},				};			function  shoppingDistrictsAdd(districts){		var districtsArray=districts;		for ( var i = 0; i < districtsArray.length; i++) {			var district = districtsArray[i];			shopDistrictMap.put(district,'');		}		if(districtsArray.length>0){			setshoppingDistrictsSelect();		}	}	function  setshoppingDistrictsSelect(){						var keys="";		var html="";				shopDistrictMap.each(function(key){			keys+=key+",";			html+='<span val="'+key+'" class="tag">'+key+'<button type="button" class="close">×</button></span>';					});		if(keys.length>0){			keys=keys.substring(0,keys.length-1);		}		$("#shoppingDistrictId").val(keys);		$("#shoppingDistrictsSelectTags").html(html);		$("#shoppingDistrictsSelectTags button").bind('click', function(event) {			removeDistrictsSelect(this);		});			}	function removeDistrictsSelect(obj){		var span=$(obj).parents("span");		span.remove();		shopDistrictMap.remove(span.attr("val"));		setshoppingDistrictsSelect();			}		function allSelectEvent(){				for ( var int = 0; int < nowDistricts.length; int++) {			var district = nowDistricts[int].name;			shopDistrictMap.put(district,'');		}		setshoppingDistrictsSelect();	}		func.init();	$(function() {		//默认绑定省		ProviceBind();		//绑定事件		$("#Province").change(function() {			CityBind();		})		$("#City").change(function() {			VillageBind();		})				$("#Village").change(function(){			var county = $("#County").val();			//判断区县下拉框选中的值是否为空			if (typeof(county) == "undefined" || county == "") {				return;			}			$("#countyCodeInput").val(county);		});				$("#form-field-select-1").change(function(){			agentChange();		});				$("#resetBtn").click(function(){			formReset();		});			})	function ProviceBind() {		//清空下拉数据		$("#Province").html("");		var str = "<option>==请选择===</option>";		$.ajax({			type : "POST",			url : _contentPath + '/area/province.json',			data : { },			dataType : "JSON",			async : false,			success : function(data) {				//从服务器获取数据进行绑定				$.each(data.areaDatas, function(i, item) {					str += "<option value=" + item.areaCode + ">" + item.areaName							+ "</option>";				})				//将数据添加到省份这个下拉框里面				$("#Province").append(str);			},			error : function() {				alert("Error");			}		});	}	function CityBind() {		var provice = $("#Province").val();		//判断省份这个下拉框选中的值是否为空		if (typeof(provice) == "undefined" || provice == "" || provice == "==请选择===") {			return;		}		$("#City").html("");		$("#Village").html("");		var str = "<option>==请选择===</option>";		$("#Village").append(str);		$.ajax({			type : "POST",			url : _contentPath + '/area/city.json',			data : { city : provice },			dataType : "JSON",			async : false,			success : function(data) {				//从服务器获取数据进行绑定				$.each(data.areaDatas, function(i, item) {					str += "<option value=" + item.areaCode + ">" + item.areaName							+ "</option>";				})				//将数据添加到市(直辖市)这个下拉框里面				$("#City").append(str);			},			error : function() {				alert("Error");			}		});	}	function VillageBind() {		var provice = $("#City").val();		var userId = $("#userIdInput").val();		//判断市这个下拉框选中的值是否为空		if (typeof(provice) == "undefined" || provice == "" || provice == "==请选择===") {			return;		}		$("#cityCodeInput").val(provice);		$("#Village").html("");		var str = "<option>==请选择===</option>";		//将市的ID拿到数据库进行查询，查询出他的下级进行绑定		$.ajax({			type : "POST",			url : _contentPath + '/area/county.json',			data : { county : provice, userId : userId },			dataType : "JSON",			async : false,			success : function(data) {				//从服务器获取数据进行绑定				$.each(data.areaDatas, function(i, item) {					str += "<option value=" + item.areaCode + ">" + item.areaName							+ "</option>";				})				//将数据添加到区县这个下拉框里面				$("#Village").append(str);			},			error : function() {				alert("Error");			}		});		//$.post("/Home/GetAddress", { parentiD: provice, MyColums: "Village" }, function (data) {  		//    $.each(data.Data, function (i, item) {		//        str += "<option value=" + item.Id + ">" + item.MyTexts + "</option>";		//    })		//    $("#Village").append(str);		//})	}		//代理商等级改变事件	function agentChange(){		var agentLevel = $("#form-field-select-1").val();		if(agentLevel == 2){			$("#area").show();		}else{			$("#area").hide();			$("#provinceCodeInput").val(null);			$("#cityCodeInput").val(null);			$("#countyCodeInput").val(null);			//默认绑定省			ProviceBind();			var str = "<option>==请选择===</option>";			$("#City").html("");			$("#City").append(str);			$("#Village").html("");			$("#Village").append(str);		}	}		//表单重置	function formReset(){		$("#newTeacherForm")[0].reset();		agentChange();	}		function clean(){		 ProviceBind();		 var str = "<option>==请选择===</option>";		 $("#City").html("");		 $("#City").append(str);		 $("#Village").html("");		 $("#Village").append(str);		 $("#upPhoneInput").val(null);		 $("#upUserNameInput").val(null);		 $("#upAagentLevelInput").val(null);		 $("#agentLevelOldInput").val(null);		 $("#agentPiontOldInput").val(null);		 $("#parentIdInput").val(null)	}		});
